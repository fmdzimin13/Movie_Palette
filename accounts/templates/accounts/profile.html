{% load bootstrap5 %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/jejumyeongjo.css">
  <script src="https://kit.fontawesome.com/caed28bd65.js" crossorigin="anonymous"></script>
  {% bootstrap_css %}
  <style>
    img {
      width: 180px;
      height: 250px;
      margin-right: 2rem;
    }

    .color {
      opacity: 0.2;
    }
  </style>
</head>
<body style="background-color: rgb(241, 241, 243); font-family: 'Jeju Myeongjo', serif;">
{% include "nav.html" %}
{% with followings=person.followings.all followers=person.followers.all %}
  <div class="container d-flex justify-content-center text-center" id="profile">
  <div class="row mb-5 pb-5" style="border-radius: 20px; width:80%; background-color: white">
    <div id="myColor" class="mt-5 offset-3 col-4" style="text-align:start; margin:0 auto; height: 420px; border: 1px solid rgb(194, 194, 194);">
      <div class="mt-2" style="height: 250px; background-color: rgb(241, 241, 243)"></div>
      <h2 class="mx-3 mt-2" style="font-weight: bold; letter-spacing :3px;">{{ person.username }}</h2>
      <!-- 팔로우 버튼 -->
      {% if request.user != person %}
      <form id="follow-form" data-user-id="{{ person.pk }}">
        {% csrf_token %}
        {% if request.user in followers %}
          <button class="btn mx-3 px-0 pt-0" role="button" style="height: 30px; width: 80px; color: white; background-color: rgb(182, 180, 180);">unfollow</button>
        {% else %}
          <button class="btn mx-3 px-0 pt-0" role="button" style="height: 30px; width: 80px; color: white; background-color: #fdced6;;">follow</button>
        {% endif %}
      </form>
      {% endif %}
      <p class="mt-3 mx-3 mb-0">FF8243</p>
      <p class="mx-3">Mango Tango</p>
    </div>
    <div class="mt-5 col-1 mx-2" style="height: 420px; border-left: 1.5px solid rgb(200, 200, 202);"></div>
    <div id="followInfo" class="col-5" style="text-align:start; margin-top: 80px;">
      <p id="follow-count" class="lead mb-5">
        followings : {{ followings|length }} | followers : {{ followers|length }}
      </p>
      <p>{{ person.review_set.all|length }} 개의 리뷰</p>
      <p>{{ person.comment_set.all|length }} 개의 댓글</p>
      <p>{{ person.like_movies.all|length }} 개의 영화</p>
      <!-- 팔레트 정보 -->
      <div class="mt-5">
        <p>{{ person.username }}님의 movie palette</p>
        <div class="d-flex">
          <div id="red" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: red;"></div>
          <div id="yellow" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: yellow;"></div>
          <div id="green" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: green;"></div>
          <div id="blue" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: blue;"></div>
          <div id="purple" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: purple;"></div>
        </div>
        <div class="d-flex mt-1">
          <div id="orange" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: orange;"></div>
          <div id="greenyellow" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: greenyellow;"></div>
          <div id="bluegreen" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: #005666;"></div>
          <div id="darkblue" class="color mx-1" style="border-radius:50%; width: 40px; height: 40px; background-color: darkblue;"></div>
          <div id="redpurple" class="color mx-1"style="border-radius:50%; width: 40px; height: 40px; background-color: #9B0143;"></div>
        </div>
      </div>
    </div>

    <!-- 좋아한 영화 carousel -->
    <div id="myMovies" class="p-3 mb-5 mt-5" style="margin: 0 auto; background-color: rgb(241, 241, 243); width: 90%; height: 330px;">
      <!-- 한 페이지에 5개씩 carousel로 나타내기 -->
      <p class="lead">{{ person.username }}님이 좋아한 영화</p>
      <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="https://lh3.googleusercontent.com/proxy/XBBCoFEVyTlGCus_FK0OECAo5dgU5og57fUwlN0qPqsSg3zWoTVFfeB4sXY2rGOyxxvw19hEsr0JANyiorXg3tiUOfcGhqJZl_Q9gofionUaKZeteO1osUEPS68Qb31Fq2v7mAaq7vecbA-oobxNJKMkMaGetnW7cPNQbQkQp8RoPyJYzSpTkYLlR7XsydheWaSsJHtGWfRidkDvt3-fNqh6XNz5uIPup5iwkBMsu24EX_VtMbR9uz-wWuc2pxYiEe6w7rCCBtVTkmWwvnKp5fv9QAKwPCulx6ZoDwuaZVq6sdTQI0RSr2kO63YZjbMemo07b-nSHlGb5UQtssdj-nVV0TGSJ4wzGnYWNedi4swD0g" alt="...">
            <img src="https://lh3.googleusercontent.com/proxy/XBBCoFEVyTlGCus_FK0OECAo5dgU5og57fUwlN0qPqsSg3zWoTVFfeB4sXY2rGOyxxvw19hEsr0JANyiorXg3tiUOfcGhqJZl_Q9gofionUaKZeteO1osUEPS68Qb31Fq2v7mAaq7vecbA-oobxNJKMkMaGetnW7cPNQbQkQp8RoPyJYzSpTkYLlR7XsydheWaSsJHtGWfRidkDvt3-fNqh6XNz5uIPup5iwkBMsu24EX_VtMbR9uz-wWuc2pxYiEe6w7rCCBtVTkmWwvnKp5fv9QAKwPCulx6ZoDwuaZVq6sdTQI0RSr2kO63YZjbMemo07b-nSHlGb5UQtssdj-nVV0TGSJ4wzGnYWNedi4swD0g" alt="...">
            <img src="https://lh3.googleusercontent.com/proxy/XBBCoFEVyTlGCus_FK0OECAo5dgU5og57fUwlN0qPqsSg3zWoTVFfeB4sXY2rGOyxxvw19hEsr0JANyiorXg3tiUOfcGhqJZl_Q9gofionUaKZeteO1osUEPS68Qb31Fq2v7mAaq7vecbA-oobxNJKMkMaGetnW7cPNQbQkQp8RoPyJYzSpTkYLlR7XsydheWaSsJHtGWfRidkDvt3-fNqh6XNz5uIPup5iwkBMsu24EX_VtMbR9uz-wWuc2pxYiEe6w7rCCBtVTkmWwvnKp5fv9QAKwPCulx6ZoDwuaZVq6sdTQI0RSr2kO63YZjbMemo07b-nSHlGb5UQtssdj-nVV0TGSJ4wzGnYWNedi4swD0g" alt="...">
            <img src="https://lh3.googleusercontent.com/proxy/XBBCoFEVyTlGCus_FK0OECAo5dgU5og57fUwlN0qPqsSg3zWoTVFfeB4sXY2rGOyxxvw19hEsr0JANyiorXg3tiUOfcGhqJZl_Q9gofionUaKZeteO1osUEPS68Qb31Fq2v7mAaq7vecbA-oobxNJKMkMaGetnW7cPNQbQkQp8RoPyJYzSpTkYLlR7XsydheWaSsJHtGWfRidkDvt3-fNqh6XNz5uIPup5iwkBMsu24EX_VtMbR9uz-wWuc2pxYiEe6w7rCCBtVTkmWwvnKp5fv9QAKwPCulx6ZoDwuaZVq6sdTQI0RSr2kO63YZjbMemo07b-nSHlGb5UQtssdj-nVV0TGSJ4wzGnYWNedi4swD0g" alt="...">
          </div>
          <div class="carousel-item">
            <img src="https://movie-phinf.pstatic.net/20210429_50/1619658051996HIPXs_JPEG/movie_image.jpg" alt="...">
            <img src="https://movie-phinf.pstatic.net/20210429_50/1619658051996HIPXs_JPEG/movie_image.jpg" alt="...">
            <img src="https://movie-phinf.pstatic.net/20210429_50/1619658051996HIPXs_JPEG/movie_image.jpg" alt="...">
            <img src="https://movie-phinf.pstatic.net/20210429_50/1619658051996HIPXs_JPEG/movie_image.jpg" alt="...">
          </div>
        </div>
        <span class="carousel-control-prev carousel-control-prev-icon" style="top: 130px; color:grey;" aria-hidden="true" data-bs-target="#carouselExampleControls" data-bs-slide="prev"></span>
        <span class="visually-hidden">Previous</span>
        <span class="carousel-control-next carousel-control-next-icon" style="top: 130px; color:grey; " aria-hidden="true" data-bs-target="#carouselExampleControls" data-bs-slide="next"></span>
        <span class="visually-hidden">Next</span>
      </div>
      <!-- {% for movie in person.like_movies.all %}
        <img src="{{ movie.poster_path }}" alt="">
        
      {% endfor %} -->
    </div>

    <!-- 활동 정보 -->
    <div class="row" style="margin: 0 auto">
      <ul class="col-4 list-group list-group-flush">
      <p class="mb-3 lead">{{ person.username }}님의 게시글</p>
        {% for review in person.review_set.all %}
          <li class="list-group-item">
            <div>{{ review.title }}</div>
          </li>
        {% endfor %}
      </ul> 
      <ul class="col-4 list-group list-group-flush">
        <p class="lead">{{ person.username }}님의 댓글</p>
        {% for comment in person.comment_set.all %}
          <li class="list-group-item">
            <div>{{ comment.content }}</div>
          </li>
        {% endfor %}
      </ul>
      <ul class="col-4 list-group list-group-flush">
        <p class="lead">{{ person.username }}님이 좋아한 리뷰</p>
        {% for review in person.like_reviews.all %}
          <li class="list-group-item">
            <div>{{ review.title }}</div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endwith %}
</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

  // 팔로우 구현
  const form = document.querySelector('#follow-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  form.addEventListener('submit', function (event) {
    event.preventDefault()
    const userId = event.target.dataset.userId
    axios.post(`http://127.0.0.1:8000/accounts/follow/${userId}/`, {}, {
      headers: {
        'X-CSRFToken': csrftoken
      }
    })
    .then(function (response) {
      const { followed, followersCount, followingsCount } = response.data
      const followStatus = document.querySelector('#follow-count')
      const followBtn = document.querySelector('#follow-form > button')

      followStatus.innerText = `followings : ${followingsCount} / followers : ${followersCount}`
      followBtn.innerText = followed ? 'unfollow' : 'follow'
    })
    .catch(function (error) {
      if (error.response.status === 401) {
        window.location.href = 'http://127.0.0.1:8000/accounts/login/'
      }
    })


    // 팔레트 색깔 구현
    // 해당 장르의 영화 개수의 비율로 컬러 투명도 조절
    const red = document.querySelector('#red')
    const orange = document.querySelector('#orange')
    const yellow = document.querySelector('#yellow')
    const yellowgreen = document.querySelector('#yellowgreen')
    const green = document.querySelector('#green')
    const bluegreen = document.querySelector('#bluegreen')
    const blue = document.querySelector('#blue')
    const darkblue = document.querySelector('#darkblue')
    const purple = document.querySelector('#purple')
    const redpurple = document.querySelector('#redpurple')

    const movies = "{{ person.like_movies.all }}"
    const count = movies.length
    const redCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const orangeCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const yellowCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const yellowgreenCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const greenCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const bluegreenCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const blueCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const darkblueCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const purpleCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
    const redpurpleCount = movies.filter(function (movie) {
      return movie.custom_genre === 1
    }).length / count
  })

  red.style.opacity = 0.1 + redCount
  orange.style.opacity = 0.1 + orangeCount
  yellow.style.opacity = 0.1 + yellowCount
  yellowgreen.style.opacity = 0.1 + yellowgreenCount
  green.style.opacity = 0.1 + greenCount
  bluegreen.style.opacity = 0.1 + bluegreenCount
  blue.style.opacity = 0.1 + blueCount
  darkblue.style.opacity = 0.1 + darkblueCount
  purple.style.opacity = 0.1 + purpleCount
  redpurple.style.opacity = 0.1 + redpurpleCount

</script>
{% bootstrap_javascript %}
</body>
</html>