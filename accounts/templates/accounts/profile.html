{% load bootstrap5 %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/jejumyeongjo.css">
  <script src="https://kit.fontawesome.com/caed28bd65.js" crossorigin="anonymous"></script>
  {% bootstrap_css %}
</head>
<body style="background-color: rgb(241, 241, 243); font-family: 'Jeju Myeongjo', serif;">
{% include "nav.html" %}
{% with followings=person.followings.all followers=person.followers.all %}
  <div class="container d-flex justify-content-center text-center" id="profile">
  <div class="row mb-4" style="border-radius: 20px; width:80%; height:830px; background-color: white">
    <div id="myColor" class="mt-5 offset-3 col-4" style="text-align:start; margin:0 auto; height: 420px; border: 1px solid rgb(194, 194, 194);">
      <div class="mt-2" style="height: 250px; background-color: rgb(241, 241, 243)"></div>
      <h2 class="mx-3 mt-2" style="font-weight: bold; letter-spacing :3px;">{{ person.username }}</h2>
      <!-- 팔로우 버튼 -->
      {% if request.user != person %}
      <form id="follow-form" data-user-id="{{ person.pk }}">
        {% csrf_token %}
        {% if request.user in followers %}
          <button class="btn mx-3 px-0 pt-0" role="button" style="height: 30px; width: 80px; background-color: darkgrey;">unfollow</button>
        {% else %}
          <button class="btn mx-3 px-0 pt-0" role="button" style="height: 30px; width: 80px; background-color:rgb(253, 200, 208) ;">follow</button>
        {% endif %}
      </form>
      {% endif %}
      <p class="mt-3 mx-3 mb-0">FF8243</p>
      <p class="mx-3">Mango Tango</p>
    </div>
    <div class="mt-5 col-1 mx-2" style="height: 420px; border-left: 1.5px solid rgb(200, 200, 202);"></div>
    <div id="followInfo" class="col-5" style="text-align:start; margin-top: 150px;">
      <p id="follow-count" class="lead">
        followings : {{ followings|length }} | followers : {{ followers|length }}
      </p>
      <p class="lead">{{ person.review_set.all|length }} 개의 리뷰</p>
      <p class="lead">{{ person.comment_set.all|length }} 개의 댓글</p>
      <p class="lead">{{ person.like_movies.all|length }} 개의 영화</p>
    </div>

    <!-- 팔레트 정보 -->
    <div id="myPalette">
      <div class="d-flex justify-content-center" style="margin:auto; width: 300px; height: 30px;">
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: red;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: orange;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: yellow;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: greenyellow;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: green;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: #005666;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: blue;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: darkblue;"></div>
        <div class="mx-1" style="border-radius:50%; width: 20px; height: 20px; background-color: purple;"></div>
        <div class="mx-1"style="border-radius:50%; width: 20px; height: 20px; background-color: #9B143;"></div>
      </div>
    </div>
    <div id="myMovies" style="background-color: rgb(49, 49, 49);">
      <!-- 한 페이지에 5개씩 carousel로 나타내기 -->
      {% for movie in person.like_movies.all %}
        <img src="{{ movie.poster_path }}" alt="">
      {% endfor %}
    </div>

    <!-- 활동 정보 -->
    <div class="row mt-4 mx-4">
      <ul class="col-4 list-group list-group-flush">
      <h4 class="mb-3">{{ person.username }}님의 게시글</h4>
        {% for review in person.review_set.all %}
          <li class="list-group-item">
            <div>{{ review.title }}</div>
          </li>
        {% endfor %}
      </ul> 
      <ul class="col-4 list-group list-group-flush">
        <h4>{{ person.username }}님의 댓글</h4>
        {% for comment in person.comment_set.all %}
          <li class="list-group-item">
            <div>{{ comment.content }}</div>
          </li>
        {% endfor %}
      </ul>
      <ul class="col-4 list-group list-group-flush">
        <h4>{{ person.username }}님이 좋아한 리뷰</h4>
        {% for review in person.like_reviews.all %}
          <li class="list-group-item">
            <div>{{ review.title }}</div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endwith %}
</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const form = document.querySelector('#follow-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  form.addEventListener('submit', function (event) {
    event.preventDefault()
    const userId = event.target.dataset.userId
    axios.post(`http://127.0.0.1:8000/accounts/follow/${userId}/`, {}, {
      headers: {
        'X-CSRFToken': csrftoken
      }
    })
    .then(function (response) {
      const { followed, followersCount, followingsCount } = response.data
      const followStatus = document.querySelector('#follow-count')
      const followBtn = document.querySelector('#follow-form > button')

      followStatus.innerText = `followings : ${followingsCount} / followers : ${followersCount}`
      followBtn.innerText = followed ? 'unfollow' : 'follow'
    })
    .catch(function (error) {
      if (error.response.status === 401) {
        window.location.href = 'http://127.0.0.1:8000/accounts/login/'
      }
    })
  })
</script>
</body>
</html>